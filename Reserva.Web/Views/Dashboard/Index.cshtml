@using Reserva.Web.Infra
@model IEnumerable<Reserva.Domain.Entities.ReservaSala>

@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles
{
    @Styles.Render("~/bundles/fullCalendar/css", "~/bundles/sweetAlert/css")
}
<div class="row">
    <div class="col-lg-12">
        <div class="hpanel">
            <div class="panel-heading">
                <div class="panel-tools">
                    <a class="showhide"><i class="fa fa-chevron-up"></i></a>
                    <a class="closebox"><i class="fa fa-times"></i></a>
                </div>
                Calendar
            </div>
            <div class="panel-body">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

@section scripts
{
    @Scripts.Render("~/bundles/moment/js", "~/bundles/fullCalendar/js", "~/bundles/sweetAlert/js")
    <script>

        $(function() {

            var meuCodigo = '@Sessao.UsuarioAtivo.Codigo';

            /* initialize the external events
             -----------------------------------------------------------------*/

            $('#external-events div.external-event').each(function() {

                // store data so the calendar knows to render an event upon drop
                $(this).data('event',
                    {
                        title: $.trim($(this).text()), // use the element's text as the event title
                        stick: true // maintain when user navigates (see docs on the renderEvent method)
                    });

                // make the event draggable using jQuery UI
                $(this).draggable({
                    zIndex: 1111999,
                    revert: true, // will cause the event to go back to its
                    revertDuration: 0 //  original position after the drag
                });

            });


            /* initialize the calendar
             -----------------------------------------------------------------*/

            $('#calendar').fullCalendar({
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'month,agendaWeek,agendaDay'
                },
                editable: true,
                eventDrop: function(event, delta, revertFunc) {

                    updateReserva(event, revertFunc);
                },
                eventResize: function(event, delta, revertFunc) {

                    updateReserva(event, revertFunc);
                },
                events: function(start, end, timezone, callback) {
                    $.ajax({
                        url: '/Reservas',
                        dataType: 'json',
                        data: {
                            // our hypothetical feed requires UNIX timestamps
                            start: start.format("YYYY-MM-DD"),
                            end: end.format("YYYY-MM-DD")
                        },
                        success: function(doc) {
                            getSuccess(doc, callback);
                        }
                    });
                }
            });

            function getSuccess(doc, callback) {
                var events = [];

                for (var i in doc) {
                    if (doc.hasOwnProperty(i)) {
                        var evento = doc[i];
                        events.push({
                            title: evento.Usuario.Nome,
                            start: evento.DtInicio,
                            end: evento.DtFim,
                            editable: evento.Usuario.Codigo == meuCodigo,
                            id: evento.Codigo,
                            dados: evento
                        });
                    }
                }

                callback(events);
            }

            function updateReserva(event, revertFunc) {
                var dados = event.dados;
                dados.DtInicio = event.start.format();
                dados.DtFim = event.end ? event.end.format() : event.start.format();

                swal({
                        title: "Alterar reserva?",
                        text: "Deseja confirmar alteração da reserva?",
                        type: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#DD6B55",
                        confirmButtonText: "Sim, alterar data",
                        cancelButtonText: "Cancelar",
                        closeOnConfirm: false,
                        closeOnCancel: true
                    },
                    function(isConfirm) {
                        if (isConfirm) {
                            debugger;
                            $.ajax({
                                url: '/Reservas/' + dados.Codigo,
                                dataType: 'json',
                                type: 'PUT',
                                data: dados,
                                success: function() {
                                    swal("Sucesso!", "Reserva alterada com sucesso.", "success");
                                },
                                error: function() {
                                    swal("Deu ruim!", "Ocorreu um erro de comunicação.", "error");
                                    revertFunc();
                                }
                            });

                        } else {
                            revertFunc();
                        }
                    });
            }
        });

    </script>
}